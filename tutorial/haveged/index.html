<!doctype html>
<html lang="en">
<head>
    <meta name="generator" content="wlanboy" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="wlanboy wlanboy.com tutorials and ruby scripts">
    <title>wlanboy - tutorials and ruby scripts - haveged</title>

    <link rel="stylesheet" href="/css/pure-min.css">
    <link rel="stylesheet" href="/css/grids-responsive-min.css">
    <link rel="stylesheet" href="/css/font-awesome.css">
    <link rel="stylesheet" href="/css/layouts/wlanboy.css">
</head>
<body>

<div class="header" id="header">
    <div class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed">
        <ul class="pure-menu-list">
            <li class="pure-menu-item pure-menu-selected"><a href="/#" class="pure-menu-link">Home</a></li>
            <li class="pure-menu-item"><a href="/#Tutorials" class="pure-menu-link">Tutorials</a></li>
            <li class="pure-menu-item"><a href="/#Gists" class="pure-menu-link">Gists</a></li>
            <li class="pure-menu-item"><a href="/#System" class="pure-menu-link">System</a></li>
            <li class="pure-menu-item"><a href="/#About" class="pure-menu-link">About</a></li>
        </ul>
    </div>
</div>

<div class="splash-container">
    <div class="splash">
        <h1 class="splash-head">wlanboy</h1>
        <p class="splash-subhead">
            tutorials and ruby scripts
        </p>
        <p>
            <a href="/#Tutorials" class="pure-button pure-button-primary">Read my tutorials</a>
        </p>
    </div>
</div>
<div class="content-wrapper" id="Tutorial">
    <div class="content">
    <h2 class="content-head is-center" >Tutorial</h2>
        <div class="pure-g">
            <div class="l-box-lrg pure-u-1">
            <h2 id="tutorial-haveged">Tutorial: haveged</h2>
<p>Encryption is based on two main factors:</p>
<ul>
<li>prime numbers</li>
<li>random numbers</li>
</ul>
<p>On Linux the random numbers are generated by the pseudo random number generator.</p>
<p>It generates randomness from hardware interrupts e.g. by keyboard, mouse, disk or network I/O.</p>
<p>The main difference between /dev/random and /dev/urandom is that first is a blocking device.</p>
<p>So /dev/random waits until the entropy pool is filled to return random data.</p>
<p>/dev/urandom does not wait and therefore gerenates random data in a lower quality.</p>
<p>Lower quality means that previous data is repeated more likely.</p>
<p>So the quality of the entropy pool does have a direct inpact on the quality of SSL/TLS and other block ciphers.</p>
<p>One of my small servers does have a quite low entropy level:</p>
<pre class="prettyprint">cat /proc/sys/kernel/random/entropy_avail
129
</pre>
<p>One of my big (and busy) KVM servers does not have that problem:</p>
<pre class="prettyprint">cat /proc/sys/kernel/random/entropy_avail
4968
</pre>
<p>A level beyond 1000 is critical if you are using any OpenSSL based encryption.</p>
<p>If your server is handling a lot of SSL traffic (and handshakes) like any webserver or mailserver does, two things can happen:</p>
<ul>
<li>The server waits until /dev/random is ready again</li>
<li>The server switches to /dev/urandom or it&rsquo;s own random generator (after a timeout)</li>
</ul>
<p>There are userland solution like the <a href="http://vanheusden.com/aed" title="External link">audio_entropyd</a> or the <a href="http://vanheusden.com/ved/" title="External link">video_entropyd</a> to feed the entropy pool, but they are not usable for headless servers.</p>
<p>But there are solutions for servers too - one of them is haveged.</p>
<p>It is a daemon that feeds the /dev/random pool on Linux using an adaptation of the HArdware Volatile Entropy Gathering and Expansion algorithm.</p>
<p>Installation is simple:</p>
<pre class="prettyprint">apt-get install haveged
</pre>
<p>Afterwards you have to check the default settings to ensure that enough bits are generated:</p>
<pre class="prettyprint">nano /etc/default/haveged
</pre>
<p>Content:</p>
<pre class="prettyprint"># Configuration file for haveged

# Options to pass to haveged:
#   -w sets low entropy watermark (in bits)
DAEMON_ARGS="-w 2048"
</pre>
<p>After starting the server:</p>
<pre class="prettyprint">service haveged start
</pre>
<p>the entropy level is raising:</p>
<pre class="prettyprint">cat /proc/sys/kernel/random/entropy_avail
142
cat /proc/sys/kernel/random/entropy_avail
153
cat /proc/sys/kernel/random/entropy_avail
170
cat /proc/sys/kernel/random/entropy_avail
188
</pre>
<p>You should then set the daemon to autostart:</p>
<pre class="prettyprint">update-rc.d haveged defaults
</pre>
<p>There are - of course - better tests than cat to check if your entropy is ok:</p>
<pre class="prettyprint">apt-get install rng-tools
</pre>
<p>rng-test is using the <a href="http://en.wikipedia.org/wiki/FIPS_140-2" title="External link">FIPS-140 method</a> to check the entropy:</p>
<pre class="prettyprint">cat /dev/random | rngtest -c 1000
</pre>
<p>Output would be:</p>
<pre class="prettyprint">rngtest 2-unofficial-mt.14
Copyright (c) 2004 by Henrique de Moraes Holschuh
This is free software; see the source for copying conditions.  There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

rngtest: starting FIPS tests...
rngtest: bits received from input: 2000032
rngtest: FIPS 140-2 successes: 1000
rngtest: FIPS 140-2 failures: 0
rngtest: FIPS 140-2(2001-10-10) Monobit: 0
rngtest: FIPS 140-2(2001-10-10) Poker: 0
rngtest: FIPS 140-2(2001-10-10) Runs: 0
rngtest: FIPS 140-2(2001-10-10) Long run: 0
rngtest: FIPS 140-2(2001-10-10) Continuous run: 0
rngtest: input channel speed: (min=8.557; avg=17.635; max=24.236)Mibits/s
rngtest: FIPS tests speed: (min=68.610; avg=156.648; max=188.846)Mibits/s
rngtest: Program run time: 133849 microseconds
</pre>
<p>On 1000 runs there should not be more than 1 to 5 failures.</p>
<p>So check the line:</p>
<pre class="prettyprint">rngtest: FIPS 140-2 failures:
</pre><blockquote>
</blockquote>

            </div>
        </div>
    </div>

    <div class="footer l-box is-center">
        <p class="footer">
            wlanboy.com | Proudly powered by Ruby | Github
        </p>
    </div>
</div>

</body></html>